#
# Sends an ABM out each of the QSFP ports
#
# A "pattern" is a 32-bit integer.  In the ABM that gets output, the upper
# 16-bits of the pattern will be repeated 32 times, then the lower 16-bits
# of the pattern will be repeated 32 times, with ths sequence repeating for
# the entire length of the ABM.
#
# Each of the two QSFP ports requires a pattern.
#
# This script and the RTL design it uses were written by D. Wolf
#


# Define the RTL registers
   REG_RTL_ID=0x0014
 REG_PATTERN0=0x1000
 REG_PATTERN1=0x1004
      REG_RUN=0x1008
REG_QSFP_STAT=0x100C

# Fetch the bitmap patterns from the command line and assign defaults
pattern0=$1
pattern1=$2
test -z $pattern0 && pattern0=0xAA00AA00
test -z $pattern1 && pattern1=0x00CC00CC

# Make sure we have the correct RTL loaded
if [ $(pcireg -dec $REG_RTL_ID) -ne 6142024 ]; then
    echo "abm_gen RTL not loaded" 1>&2
    exit 1
fi

# Fetch the "PCS alignment" status bits
aligned=$(pcireg -dec $REG_QSFP_STAT)

# Tell the user if one of the cables isn't plugged in
test $((aligned & 1)) -eq 0 && echo "QSFP_0 appears disconnected!" 1>&2
test $((aligned & 2)) -eq 0 && echo "QSFP_1 appears disconnected!" 1>&2
test $aligned -ne 3 && exit 1

# Ensure that we're not currently sending an ABM
while [ $(pcireg -dec $REG_RUN) -ne 0 ]; do
    sleep .01
done

# Program the two patterns we want to send
pcireg $REG_PATTERN0 $pattern0
pcireg $REG_PATTERN1 $pattern1

# Send the ABM
pcireg $REG_RUN 1

# Wait for the send to complete
while [ $(pcireg -dec $REG_RUN) -ne 0 ]; do
    sleep .01
done
